name: Android CI

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  instrumentation-tests:
    if: github.event.pull_request.draft == false
    runs-on: [ self-hosted, Android ]
    strategy:
      matrix:
        api-level: [ 34 ]
        target: [ google_apis ]

    steps:
      - name: Checkout the code
        uses: actions/checkout@v5.0.0
        with:
          token: ${{ github.token }}
          submodules: recursive

      # Setup Gradle and run Build
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean gradle cache
        run: ./gradlew clean

      - name: Build with Gradle
        run: ./gradlew build

      # Run UI tests
      - name: Run UI tests
        run: |
          echo "Installing Maestro"

          curl -fsSL "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH":"$HOME/.maestro/bin"
          
          echo "Exporting environment variables"
          export PATH="$PATH":":/Users/runner/Library/Android/sdk/platform-tools"
          export PATH="$PATH":":/Users/runner/Library/Android/sdk/emulator"

          APK_SEARCH_DIR="app/build/outputs/apk/standard/debug"
          APP_APK_PATH=$(find "$APK_SEARCH_DIR" -maxdepth 1 -type f -name "*.apk" | head -n 1)

          if [ ! -f "$APP_APK_PATH" ]; then
            echo "APK not found at $APP_APK_PATH"
            exit 1
          fi
                    
          echo "Installing $APP_APK_PATH on emulator"
          adb install "$APP_APK_PATH"
          
          echo "Starting UI tests"
          maestro test --output report.xml "$APP_APK_PATH" -e=ACCOUNT_EMAIL=${{ secrets.UI_TEST_ACCOUNT_EMAIL }} -e=ACCOUNT_PASSWORD=${{ secrets.UI_TEST_ACCOUNT_PASSWORD }} ./maestro/flow/login.yaml ./maestro/flow/writeEmail.yaml ./maestro/flow/logout.yaml
